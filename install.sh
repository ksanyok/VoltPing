#!/bin/bash
#===============================================================================
#  ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó 
#  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù 
#  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ñà‚ïó
#  ‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë
#   ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù
#    ‚ïö‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù 
#                                                                 
#  Universal Power Monitoring Installer v1.0
#  –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –µ–ª–µ–∫—Ç—Ä–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è
#===============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# Repository URL (change this to your public repo)
REPO_URL="${VOLTPING_REPO:-https://raw.githubusercontent.com/your-org/voltping/main}"

# Installation directory
INSTALL_DIR="${1:-$(pwd)/voltping}"

#===============================================================================
# Helper Functions
#===============================================================================

print_banner() {
    echo -e "${CYAN}"
    echo '  ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó '
    echo '  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù '
    echo '  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ñà‚ïó'
    echo '  ‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë'
    echo '   ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù'
    echo '    ‚ïö‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù '
    echo -e "${NC}"
    echo -e "${BOLD}  Universal Power Monitoring System v1.0${NC}"
    echo -e "  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
}

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[‚úì]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

log_error() {
    echo -e "${RED}[‚úó]${NC} $1"
}

log_step() {
    echo -e "\n${CYAN}‚îÅ‚îÅ‚îÅ $1 ‚îÅ‚îÅ‚îÅ${NC}\n"
}

prompt() {
    local var_name="$1"
    local prompt_text="$2"
    local default_value="$3"
    local is_required="${4:-false}"
    local is_secret="${5:-false}"
    
    if [ -n "$default_value" ]; then
        prompt_text="${prompt_text} [${default_value}]"
    fi
    
    while true; do
        if [ "$is_secret" = "true" ]; then
            read -s -p "$(echo -e "${YELLOW}?${NC} ${prompt_text}: ")" value
            echo ""
        else
            read -p "$(echo -e "${YELLOW}?${NC} ${prompt_text}: ")" value
        fi
        
        value="${value:-$default_value}"
        
        if [ "$is_required" = "true" ] && [ -z "$value" ]; then
            log_error "–¶–µ –ø–æ–ª–µ –æ–±–æ–≤'—è–∑–∫–æ–≤–µ!"
            continue
        fi
        
        eval "$var_name=\"$value\""
        break
    done
}

prompt_yes_no() {
    local prompt_text="$1"
    local default="${2:-y}"
    
    if [ "$default" = "y" ]; then
        prompt_text="${prompt_text} [Y/n]"
    else
        prompt_text="${prompt_text} [y/N]"
    fi
    
    read -p "$(echo -e "${YELLOW}?${NC} ${prompt_text}: ")" answer
    answer="${answer:-$default}"
    
    [[ "${answer,,}" =~ ^(y|yes|—Ç–∞–∫)$ ]]
}

#===============================================================================
# Prerequisites Check
#===============================================================================

check_prerequisites() {
    log_step "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –≤–∏–º–æ–≥"
    
    local missing=()
    
    # Check PHP
    if command -v php &> /dev/null; then
        PHP_VERSION=$(php -v | head -n 1 | cut -d' ' -f2 | cut -d'.' -f1,2)
        log_success "PHP $PHP_VERSION –∑–Ω–∞–π–¥–µ–Ω–æ"
    else
        missing+=("php")
        log_error "PHP –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
    fi
    
    # Check curl
    if command -v curl &> /dev/null; then
        log_success "curl –∑–Ω–∞–π–¥–µ–Ω–æ"
    else
        missing+=("curl")
        log_error "curl –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
    fi
    
    # Check Python 3.9+ (optional for local Tuya)
    if command -v python3 &> /dev/null; then
        PYTHON_VERSION=$(python3 --version | cut -d' ' -f2)
        log_success "Python $PYTHON_VERSION –∑–Ω–∞–π–¥–µ–Ω–æ (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è)"
    else
        log_warning "Python3 –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è)"
    fi
    
    # Check if web server is available
    if command -v nginx &> /dev/null; then
        log_success "nginx –∑–Ω–∞–π–¥–µ–Ω–æ"
    elif command -v apache2 &> /dev/null || command -v httpd &> /dev/null; then
        log_success "Apache –∑–Ω–∞–π–¥–µ–Ω–æ"
    else
        log_warning "–í–µ–±-—Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ (–º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –≤–±—É–¥–æ–≤–∞–Ω–∏–π PHP —Å–µ—Ä–≤–µ—Ä)"
    fi
    
    if [ ${#missing[@]} -gt 0 ]; then
        log_error "–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –≤—ñ–¥—Å—É—Ç–Ω—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏: ${missing[*]}"
        exit 1
    fi
}

#===============================================================================
# Download Files
#===============================================================================

download_files() {
    log_step "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –ø—Ä–æ–µ–∫—Ç—É"
    
    mkdir -p "$INSTALL_DIR"
    cd "$INSTALL_DIR"
    
    local files=(
        "config.php"
        "tuya_client.php"
        "tuya_local_client.php"
        "tuya_local_poll.py"
        "watch_power.php"
        "bot.php"
        "admin.php"
        "schedule_parser.php"
        "index.php"
        "favicon.ico"
        "style.css"
    )
    
    for file in "${files[@]}"; do
        log_info "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è $file..."
        if curl -sSfL "$REPO_URL/src/$file" -o "$file" 2>/dev/null; then
            log_success "$file"
        else
            log_warning "–ü—Ä–æ–ø—É—â–µ–Ω–æ $file (–±—É–¥–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ)"
        fi
    done
    
    # Create directories
    mkdir -p logs
    mkdir -p backups
    
    log_success "–§–∞–π–ª–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ"
}

#===============================================================================
# Interactive Setup
#===============================================================================

setup_wizard() {
    log_step "–ú–∞–π—Å—Ç–µ—Ä –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è VoltPing"
    
    echo -e "${BOLD}–ö—Ä–æ–∫ 1/6: –ë–∞–∑–æ–≤—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è${NC}"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
    
    prompt PROJECT_NAME "–ù–∞–∑–≤–∞ –≤–∞—à–æ–≥–æ –ø—Ä–æ–µ–∫—Ç—É/–∫–æ–º–ø–ª–µ–∫—Å—É" "–ú—ñ–π –ë—É–¥–∏–Ω–æ–∫" true
    prompt ADMIN_PASSWORD "–ü–∞—Ä–æ–ª—å –¥–ª—è –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ" "" false true
    
    echo ""
    echo -e "${BOLD}–ö—Ä–æ–∫ 2/6: Telegram –±–æ—Ç${NC}"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
    echo -e "${CYAN}üìñ –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è:${NC}"
    echo "   1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ @BotFather –≤ Telegram"
    echo "   2. –ù–∞–¥—ñ—à–ª—ñ—Ç—å /newbot"
    echo "   3. –í–≤–µ–¥—ñ—Ç—å —ñ–º'—è –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –°–≤—ñ—Ç–ª–æ –ú—ñ–π –ë—É–¥–∏–Ω–æ–∫)"
    echo "   4. –í–≤–µ–¥—ñ—Ç—å username –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: svitlo_myhouse_bot)"
    echo "   5. –°–∫–æ–ø—ñ—é–π—Ç–µ —Ç–æ–∫–µ–Ω, —è–∫–∏–π –≤–∞–º –¥–∞—Å—Ç—å BotFather"
    echo ""
    
    prompt TG_BOT_TOKEN "Telegram Bot Token" "" true
    
    echo ""
    echo -e "${CYAN}üìñ –î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è Chat ID:${NC}"
    echo "   1. –°—Ç–≤–æ—Ä—ñ—Ç—å –∫–∞–Ω–∞–ª –∞–±–æ –≥—Ä—É–ø—É –≤ Telegram"
    echo "   2. –î–æ–¥–∞–π—Ç–µ –±–æ—Ç–∞ —è–∫ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
    echo "   3. –ù–∞–¥—ñ—à–ª—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –∫–∞–Ω–∞–ª"
    echo "   4. –í—ñ–¥–∫—Ä–∏–π—Ç–µ: https://api.telegram.org/bot<TOKEN>/getUpdates"
    echo "   5. –ó–Ω–∞–π–¥—ñ—Ç—å 'chat':{'id': -100XXXXXXXXXX}"
    echo ""
    
    prompt TG_CHAT_ID "ID –∫–∞–Ω–∞–ª—É/–≥—Ä—É–ø–∏ –¥–ª—è —Å–ø–æ–≤—ñ—â–µ–Ω—å" "" false
    prompt TG_ADMIN_ID "–í–∞—à –æ—Å–æ–±–∏—Å—Ç–∏–π Telegram ID (–¥–ª—è –∞–¥–º—ñ–Ω –∫–æ–º–∞–Ω–¥)" "" false
    
    echo ""
    echo -e "${BOLD}–ö—Ä–æ–∫ 3/6: Tuya API${NC}"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
    echo -e "${CYAN}üìñ –Ø–∫ –æ—Ç—Ä–∏–º–∞—Ç–∏ Tuya API –∫–ª—é—á—ñ:${NC}"
    echo "   1. –ó–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—å –Ω–∞ https://iot.tuya.com/"
    echo "   2. –°—Ç–≤–æ—Ä—ñ—Ç—å Cloud Project"
    echo "   3. –í–∏–±–µ—Ä—ñ—Ç—å —Ä–µ–≥—ñ–æ–Ω (EU –¥–ª—è –£–∫—Ä–∞—ó–Ω–∏)"
    echo "   4. –ü—ñ–¥–∫–ª—é—á—ñ—Ç—å Smart Life App –¥–æ –ø—Ä–æ–µ–∫—Ç—É:"
    echo "      - Devices ‚Üí Link Tuya App Account"
    echo "   5. –°–∫–æ–ø—ñ—é–π—Ç–µ Access ID —Ç–∞ Access Secret –∑ Overview"
    echo ""
    
    prompt TUYA_ACCESS_ID "Tuya Access ID (Client ID)" "" true
    prompt TUYA_ACCESS_SECRET "Tuya Access Secret" "" true true
    prompt TUYA_DEVICE_ID "Tuya Device ID (ID —Ä–æ–∑–µ—Ç–∫–∏ –∑ –Ω–∞–ø—Ä—É–≥–æ—é)" "" true
    
    echo ""
    echo -e "${BOLD}–ö—Ä–æ–∫ 4/6: –†–µ–∂–∏–º –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è${NC}"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
    echo -e "${CYAN}–î–æ—Å—Ç—É–ø–Ω—ñ —Ä–µ–∂–∏–º–∏:${NC}"
    echo "   ${GREEN}cloud${NC}  - –ß–µ—Ä–µ–∑ Tuya Cloud API (–ª—ñ–º—ñ—Ç 30,000 –∑–∞–ø–∏—Ç—ñ–≤/–º—ñ—Å—è—Ü—å)"
    echo "   ${GREEN}local${NC}  - –ü—Ä—è–º–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –ø—Ä–∏—Å—Ç—Ä–æ—é (–±–µ–∑ –ª—ñ–º—ñ—Ç—ñ–≤, —à–≤–∏–¥—à–µ)"
    echo "   ${GREEN}hybrid${NC} - Local —è–∫ –æ—Å–Ω–æ–≤–Ω–∏–π, Cloud —è–∫ —Ä–µ–∑–µ—Ä–≤"
    echo ""
    
    prompt TUYA_MODE "–†–µ–∂–∏–º –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è" "cloud" true
    
    if [ "$TUYA_MODE" = "local" ] || [ "$TUYA_MODE" = "hybrid" ]; then
        echo ""
        echo -e "${CYAN}üìñ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:${NC}"
        echo ""
        echo "   ${YELLOW}Local Key${NC} - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–ø—É—Å–∫—É"
        echo "   —è–∫—â–æ –Ω–µ –≤–¥–∞—î—Ç—å—Å—è, –æ—Ç—Ä–∏–º–∞–π—Ç–µ —á–µ—Ä–µ–∑:"
        echo "   - Tuya IoT Platform ‚Üí Devices ‚Üí All Devices ‚Üí View Details ‚Üí Local Key"
        echo "   - –ê–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ tinytuya wizard: pip install tinytuya && python -m tinytuya wizard"
        echo ""
        
        prompt TUYA_LOCAL_KEY "Local Key (–∑–∞–ª–∏—à—Ç–µ –ø—É—Å—Ç–∏–º –¥–ª—è –∞–≤—Ç–æ–≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è)" "" false true
        
        echo ""
        echo -e "${CYAN}üìñ IP –∞–¥—Ä–µ—Å–∞ –ø—Ä–∏—Å—Ç—Ä–æ—é:${NC}"
        echo "   - –õ–æ–∫–∞–ª—å–Ω–∞ IP (–¥–ª—è —Ä–æ–±–æ—Ç–∏ –≤ —Ç—ñ–π —Å–∞–º—ñ–π –º–µ—Ä–µ–∂—ñ): 192.168.x.x"
        echo "   - –ü—É–±–ª—ñ—á–Ω–∞ IP (–¥–ª—è —Ä–æ–±–æ—Ç–∏ —á–µ—Ä–µ–∑ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç): –ø–æ—Ç—Ä—ñ–±–µ–Ω port forwarding"
        echo ""
        
        prompt TUYA_LOCAL_IP "–õ–æ–∫–∞–ª—å–Ω–∞ IP –∞–¥—Ä–µ—Å–∞ –ø—Ä–∏—Å—Ç—Ä–æ—é" "" false
        prompt TUYA_PUBLIC_IP "–ü—É–±–ª—ñ—á–Ω–∞ IP (—è–∫—â–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π port forwarding)" "" false
        
        echo ""
        prompt TUYA_LOCAL_VERSION "–í–µ—Ä—Å—ñ—è –ø—Ä–æ—Ç–æ–∫–æ–ª—É Tuya" "3.5" false
    fi
    
    echo ""
    echo -e "${BOLD}–ö—Ä–æ–∫ 5/6: –Ü–Ω—Ç–µ—Ä–≤–∞–ª–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É${NC}"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
    
    prompt CHECK_INTERVAL "–Ü–Ω—Ç–µ—Ä–≤–∞–ª –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (—Å–µ–∫—É–Ω–¥)" "60" false
    prompt NOTIFY_REPEAT "–ü–æ–≤—Ç–æ—Ä—é–≤–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–∏ –∞–Ω–æ–º–∞–ª—å–Ω—ñ–π –Ω–∞–ø—Ä—É–∑—ñ (—Ö–≤–∏–ª–∏–Ω)" "60" false
    prompt VOLTAGE_WARN_LOW "–ü–æ—Ä—ñ–≥ –Ω–∏–∑—å–∫–æ—ó –Ω–∞–ø—Ä—É–≥–∏ (V)" "207" false
    prompt VOLTAGE_WARN_HIGH "–ü–æ—Ä—ñ–≥ –≤–∏—Å–æ–∫–æ—ó –Ω–∞–ø—Ä—É–≥–∏ (V)" "253" false
    prompt VOLTAGE_CRIT_LOW "–ö—Ä–∏—Ç–∏—á–Ω–æ –Ω–∏–∑—å–∫–∞ –Ω–∞–ø—Ä—É–≥–∞ (V)" "190" false
    prompt VOLTAGE_CRIT_HIGH "–ö—Ä–∏—Ç–∏—á–Ω–æ –≤–∏—Å–æ–∫–∞ –Ω–∞–ø—Ä—É–≥–∞ (V)" "260" false
    
    echo ""
    echo -e "${BOLD}–ö—Ä–æ–∫ 6/6: –ö–∞–Ω–∞–ª –≥—Ä–∞—Ñ—ñ–∫—ñ–≤ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)${NC}"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
    
    if prompt_yes_no "–ß–∏ –±–∞–∂–∞—î—Ç–µ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ –∫–∞–Ω–∞–ª –∑ –≥—Ä–∞—Ñ—ñ–∫–∞–º–∏ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å?" "n"; then
        echo ""
        echo -e "${CYAN}üìñ –§–æ—Ä–º–∞—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤ –∫–∞–Ω–∞–ª—ñ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥—É:${NC}"
        echo ""
        echo "   –ü—Ä–∏–∫–ª–∞–¥ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:"
        echo "   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
        echo "   ‚îÇ üìÖ –ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –Ω–∞ 05.02.2026    ‚îÇ"
        echo "   ‚îÇ                                        ‚îÇ"
        echo "   ‚îÇ üî¥ –ß–µ—Ä–≥–∞ 1: 00:00-06:00, 12:00-18:00  ‚îÇ"
        echo "   ‚îÇ üü° –ß–µ—Ä–≥–∞ 2: 06:00-12:00, 18:00-24:00  ‚îÇ"
        echo "   ‚îÇ üü¢ –ß–µ—Ä–≥–∞ 3: –±–µ–∑ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å            ‚îÇ"
        echo "   ‚îÇ                                        ‚îÇ"
        echo "   ‚îÇ ‚ö° –í–∞—à–∞ —á–µ—Ä–≥–∞: 1                       ‚îÇ"
        echo "   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
        echo ""
        echo "   –ü—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏:"
        echo "   - HH:MM-HH:MM (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: 08:00-12:00)"
        echo "   - HH-HH (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: 8-12)"
        echo "   - '–±–µ–∑ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å' –∞–±–æ '–Ω–µ–º–∞—î'"
        echo ""
        
        prompt SCHEDULE_CHANNEL_ID "ID –∫–∞–Ω–∞–ª—É –∑ –≥—Ä–∞—Ñ—ñ–∫–∞–º–∏" "" false
        prompt SCHEDULE_QUEUE "–ù–æ–º–µ—Ä –≤–∞—à–æ—ó —á–µ—Ä–≥–∏" "1" false
    fi
}

#===============================================================================
# Create Configuration
#===============================================================================

create_env_file() {
    log_step "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó"
    
    cat > "$INSTALL_DIR/.env" << EOF
# VoltPing Configuration
# Generated: $(date)

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# PROJECT
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
PROJECT_NAME="${PROJECT_NAME}"
CHANNEL_BASE_TITLE="${PROJECT_NAME} ‚Äî –°–≤—ñ—Ç–ª–æ ‚ö° –ù–∞–ø—Ä—É–≥–∞"

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ADMIN
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ADMIN_PASSWORD="${ADMIN_PASSWORD}"

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# TELEGRAM
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
TG_BOT_TOKEN="${TG_BOT_TOKEN}"
TG_CHAT_ID="${TG_CHAT_ID}"
TG_ADMIN_ID="${TG_ADMIN_ID}"

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# TUYA CLOUD API
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
TUYA_ENDPOINT="https://openapi.tuyaeu.com"
TUYA_ACCESS_ID="${TUYA_ACCESS_ID}"
TUYA_ACCESS_SECRET="${TUYA_ACCESS_SECRET}"
TUYA_DEVICE_ID="${TUYA_DEVICE_ID}"

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# TUYA LOCAL CONNECTION
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
TUYA_MODE="${TUYA_MODE:-cloud}"
TUYA_LOCAL_KEY="${TUYA_LOCAL_KEY}"
TUYA_LOCAL_IP="${TUYA_LOCAL_IP}"
TUYA_PUBLIC_IP="${TUYA_PUBLIC_IP}"
TUYA_LOCAL_VERSION="${TUYA_LOCAL_VERSION:-3.5}"
TUYA_LOCAL_PORT="6668"

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# MONITORING
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
CHECK_INTERVAL_SECONDS="${CHECK_INTERVAL:-60}"
NOTIFY_REPEAT_MINUTES="${NOTIFY_REPEAT:-60}"
VOLTAGE_ON_THRESHOLD="50.0"
V_WARN_LOW="${VOLTAGE_WARN_LOW:-207.0}"
V_WARN_HIGH="${VOLTAGE_WARN_HIGH:-253.0}"
V_CRIT_LOW="${VOLTAGE_CRIT_LOW:-190.0}"
V_CRIT_HIGH="${VOLTAGE_CRIT_HIGH:-260.0}"

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# SCHEDULE PARSING
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
SCHEDULE_CHANNEL_ID="${SCHEDULE_CHANNEL_ID}"
SCHEDULE_QUEUE="${SCHEDULE_QUEUE:-1}"
SCHEDULE_PARSE_ENABLED="${SCHEDULE_CHANNEL_ID:+true}"
EOF

    chmod 600 "$INSTALL_DIR/.env"
    log_success "–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é —Å—Ç–≤–æ—Ä–µ–Ω–æ: .env"
}

#===============================================================================
# Auto-detect Local Key
#===============================================================================

detect_local_key() {
    if [ -z "$TUYA_LOCAL_KEY" ] && [ "$TUYA_MODE" != "cloud" ]; then
        log_step "–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è Local Key"
        
        log_info "–°–ø—Ä–æ–±–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ Local Key —á–µ—Ä–µ–∑ Tuya Cloud API..."
        
        # Create temporary PHP script to get local key
        cat > "$INSTALL_DIR/get_local_key.php" << 'EOPHP'
<?php
require_once __DIR__ . '/config.php';
require_once __DIR__ . '/tuya_client.php';

$config = getConfig();
$client = new TuyaClient(
    $config['tuya_endpoint'],
    $config['tuya_client_id'],
    $config['tuya_secret'],
    $config['tuya_token_cache']
);

try {
    $deviceInfo = $client->getDeviceInfo($config['device_id']);
    if (isset($deviceInfo['result']['local_key'])) {
        echo $deviceInfo['result']['local_key'];
    }
} catch (Exception $e) {
    // Silent fail
}
EOPHP
        
        LOCAL_KEY=$(php "$INSTALL_DIR/get_local_key.php" 2>/dev/null || echo "")
        rm -f "$INSTALL_DIR/get_local_key.php"
        
        if [ -n "$LOCAL_KEY" ]; then
            log_success "Local Key –≤–∏–∑–Ω–∞—á–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ!"
            # Update .env file
            sed -i.bak "s/TUYA_LOCAL_KEY=\"\"/TUYA_LOCAL_KEY=\"$LOCAL_KEY\"/" "$INSTALL_DIR/.env"
            rm -f "$INSTALL_DIR/.env.bak"
        else
            log_warning "–ù–µ –≤–¥–∞–ª–æ—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–∑–Ω–∞—á–∏—Ç–∏ Local Key"
            log_info "–í–∏ –º–æ–∂–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ –π–æ–≥–æ –ø—ñ–∑–Ω—ñ—à–µ –≤ .env —Ñ–∞–π–ª"
        fi
    fi
}

#===============================================================================
# Setup Cron
#===============================================================================

setup_cron() {
    log_step "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫—É"
    
    if prompt_yes_no "–î–æ–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è –¥–æ cron –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É?" "y"; then
        CRON_INTERVAL="${CHECK_INTERVAL:-60}"
        
        # Calculate cron expression
        if [ "$CRON_INTERVAL" -le 60 ]; then
            CRON_EXPR="* * * * *"
        elif [ "$CRON_INTERVAL" -le 300 ]; then
            CRON_EXPR="*/5 * * * *"
        else
            CRON_EXPR="*/10 * * * *"
        fi
        
        CRON_LINE="$CRON_EXPR cd $INSTALL_DIR && php watch_power.php >> logs/cron.log 2>&1"
        
        (crontab -l 2>/dev/null | grep -v "voltping\|watch_power"; echo "$CRON_LINE") | crontab -
        
        log_success "Cron –∑–∞–¥–∞—á—É –¥–æ–¥–∞–Ω–æ: $CRON_EXPR"
    fi
}

#===============================================================================
# Setup Webhook
#===============================================================================

setup_webhook() {
    log_step "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Telegram Webhook"
    
    echo -e "${CYAN}üìñ –î–ª—è –ø–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ –±–æ—Ç–∞ –ø–æ—Ç—Ä—ñ–±–µ–Ω Webhook${NC}"
    echo ""
    echo "   Webhook - —Ü–µ URL, –Ω–∞ —è–∫–∏–π Telegram –Ω–∞–¥—Å–∏–ª–∞—Ç–∏–º–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è."
    echo "   –í–∏–º–æ–≥–∏:"
    echo "   - HTTPS (SSL —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç)"
    echo "   - –ü—É–±–ª—ñ—á–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ —Å–µ—Ä–≤–µ—Ä–∞"
    echo ""
    
    prompt WEBHOOK_URL "URL –¥–ª—è webhook (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: https://yourdomain.com/voltping/bot.php)" "" false
    
    if [ -n "$WEBHOOK_URL" ]; then
        log_info "–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è webhook..."
        
        RESULT=$(curl -s "https://api.telegram.org/bot${TG_BOT_TOKEN}/setWebhook?url=${WEBHOOK_URL}")
        
        if echo "$RESULT" | grep -q '"ok":true'; then
            log_success "Webhook –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!"
        else
            log_error "–ü–æ–º–∏–ª–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è webhook: $RESULT"
        fi
    else
        log_warning "Webhook –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ. –í–∏ –º–æ–∂–µ—Ç–µ –∑—Ä–æ–±–∏—Ç–∏ —Ü–µ –ø—ñ–∑–Ω—ñ—à–µ."
    fi
}

#===============================================================================
# Install Python Dependencies
#===============================================================================

install_python_deps() {
    if [ "$TUYA_MODE" = "local" ] || [ "$TUYA_MODE" = "hybrid" ]; then
        log_step "–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Python –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π"
        
        if command -v pip3 &> /dev/null; then
            pip3 install tinytuya --quiet
            log_success "tinytuya –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
        else
            log_warning "pip3 –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –≤—Ä—É—á–Ω—É: pip3 install tinytuya"
        fi
    fi
}

#===============================================================================
# Print Summary
#===============================================================================

print_summary() {
    echo ""
    echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${GREEN}  ‚úì VoltPing —É—Å–ø—ñ—à–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!${NC}"
    echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo -e "${BOLD}–î–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è:${NC} $INSTALL_DIR"
    echo ""
    echo -e "${BOLD}–ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏:${NC}"
    echo ""
    echo "  1. ${CYAN}–ù–∞–ª–∞—à—Ç—É–π—Ç–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä${NC}"
    echo "     –°–∫–æ–ø—ñ—é–π—Ç–µ —Ñ–∞–π–ª–∏ –¥–æ –≤–∞—à–æ–≥–æ –≤–µ–±-–∫–∞—Ç–∞–ª–æ–≥—É –∞–±–æ –∑–∞–ø—É—Å—Ç—ñ—Ç—å:"
    echo "     cd $INSTALL_DIR && php -S localhost:8080"
    echo ""
    echo "  2. ${CYAN}–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è${NC}"
    echo "     php $INSTALL_DIR/watch_power.php"
    echo ""
    echo "  3. ${CYAN}–í—ñ–¥–∫—Ä–∏–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram${NC}"
    echo "     –ù–∞–¥—ñ—à–ª—ñ—Ç—å /start –≤–∞—à–æ–º—É –±–æ—Ç—É"
    echo ""
    
    if [ "$TUYA_MODE" = "local" ] || [ "$TUYA_MODE" = "hybrid" ]; then
        echo "  4. ${CYAN}Port Forwarding (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∑–∑–æ–≤–Ω—ñ)${NC}"
        echo "     –ù–∞–ª–∞—à—Ç—É–π—Ç–µ –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü—ñ—é –ø–æ—Ä—Ç—É 6668 –Ω–∞ –≤–∞—à–æ–º—É —Ä–æ—É—Ç–µ—Ä—ñ"
        echo "     –ó–æ–≤–Ω—ñ—à–Ω—ñ–π –ø–æ—Ä—Ç: 6668 ‚Üí –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π: ${TUYA_LOCAL_IP}:6668"
        echo ""
    fi
    
    echo -e "${BOLD}–ö–æ—Ä–∏—Å–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è:${NC}"
    echo "  - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è: $INSTALL_DIR/docs/README.md"
    echo "  - Tuya IoT: https://iot.tuya.com/"
    echo "  - BotFather: https://t.me/BotFather"
    echo ""
    echo -e "${BOLD}–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å:${NC}"
    echo "  URL: http://your-server/admin.php"
    if [ -n "$ADMIN_PASSWORD" ]; then
        echo "  –ü–∞—Ä–æ–ª—å: [–≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ]"
    else
        echo "  –ü–∞—Ä–æ–ª—å: [–Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ - –≤—ñ–¥–∫—Ä–∏—Ç–∏–π –¥–æ—Å—Ç—É–ø]"
    fi
    echo ""
}

#===============================================================================
# Main
#===============================================================================

main() {
    print_banner
    
    check_prerequisites
    download_files
    setup_wizard
    create_env_file
    
    # Create local files first (they may be needed for detect_local_key)
    create_local_files
    
    detect_local_key
    install_python_deps
    setup_webhook
    setup_cron
    
    print_summary
}

#===============================================================================
# Create Local Files (if download failed)
#===============================================================================

create_local_files() {
    # Create config.php if not exists
    if [ ! -f "$INSTALL_DIR/config.php" ]; then
        log_info "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è config.php..."
        # This will be created by the actual PHP file from the repo
        touch "$INSTALL_DIR/config.php"
    fi
}

# Run main
main "$@"
